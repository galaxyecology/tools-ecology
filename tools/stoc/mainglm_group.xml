<tool id="stoceps_glm_group" name="Estimate temporal population evolution" version="@VERSION@">
    <description>by specialization group</description>
    <macros>
        <import>stoceps_macros.xml</import>
    </macros>
    <expand macro="mainglm_requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        Rscript 
         '$__tool_directory__/ExeMainglmParGroupGalaxy.r' 
         '$input_y_var'
         '$input_glob_tendencies'
         '$inputtabSpecies'
         'mainglm_group'
         #if $settings.advanced=='advanced' 
             $settings.sp_code
         #else
             ''
         #end if
         '$__tool_directory__/FunctTrendSTOCGalaxy.r'
         '$__tool_directory__/biais.tabular'
         
        '$data_group'
        '$year_var_group'
        '$glob_tend_group'
    ]]>
    </command>
    <inputs>
        <param name="input_y_var" type="data" format="tabular" label="Yearly variation dataset" help="Output from the 'Estimate temporal population evoution by species' tool."/>
        <param name="input_glob_tendencies" type="data" format="tabular" label="Global tendencies dataset" help="Output from the 'Estimate temporal population evoution by species' tool."/>
        <param name="inputtabSpecies" type="data" format="tabular" label="Species file" help="Input species tabular file, with 5 columns (species ID, species name, species scientific name, specialization status)." />
        <conditional name="settings">
            <expand macro="stoceps_advanced_params_select"/>
            <when value="advanced">
                <param name="sp_code" type="select" label="Filter species to exclude" help="Create a subsample by selecting the species codes you don't want to use." multiple="true" optional="true">
                    <options from_dataset="input_glob_tendencies">
                        <column name="value" index="1"/>
                        <filter type="unique_value" name="espece" column="1"/>
                    </options>
                    <sanitizer>
                        <valid initial="string.printable">
                            <remove value="&quot;"/>
                        </valid>
                    </sanitizer>
                </param>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="data_group" from_work_dir="Output/mainglm_group/donneesGroupes_mainglm_group.tabular" format="tabular" label="Glm - Group data on ${on_string}"/>
        <data name="year_var_group" from_work_dir="Output/mainglm_group/variationsAnnuellesGroupes_mainglm_group.tabular" format="tabular" label="Glm - Group yearly variations data on ${on_string}"/>
        <data name="glob_tend_group" from_work_dir="Output/mainglm_group/tendancesGlobalesGroupes_mainglm_group.tabular" format="tabular" label="Glm - Group tendencies on ${on_string}"/>
        <data name="plot_year_var_group" from_work_dir="Output/mainglm_group/variationsAnnuellesGroupes_mainglm_group.png" format="png" label="Glm - Group yearly variations plot on ${on_string}"/>
    </outputs>
    <tests>
	<test>
            <param name="inputtabSpecies" value="tabSpecies.csv"/>
            <param name="input_y_var" value="mainglm_tab_years.tabular"/>
            <param name="input_glob_tendencies" value ="mainglm_tab_global.tabular"/>
            <param name="advanced" value="simple"/>
            <output name="data_group">
		<assert_contents>
			<has_n_lines n="37"/>
			<has_size value="3277" delta="100"/>
		</assert_contents>
	    </output>
            <output name="year_var_group">
		<assert_contents>
			<has_n_lines n="37"/>
			<has_size value="1623" delta="100"/>
		</assert_contents>
	    </output>
            <output name="glob_tend_group">
		<assert_contents>
			<has_n_lines n="3"/>
			<has_size value="154" delta="20"/>
		</assert_contents>
	    </output>
            <output name="plot_year_var_group">
		<assert_contents>
			<has_size value="141535" delta="5000"/>
		</assert_contents>
	    </output>
        </test>
    </tests>
    <help><![CDATA[
=================================================
STOC Estimate species population evolution
=================================================

**What it does**



Compute and plot evolution of species population by specialization group, using a glm model.


|

**Input description**

Two tabular files processed with the STOCs 'Preprocess population data' 'Filter species' and 'mainglm' tools. 

|

**Output**


Two tabular files are created, they describe global tendencies and yearly variations per groups. One plot of yearly variations per group.
A Third "species details file" containing group status (here "specialisation") of species (Column with TRUE or FALSE), including the species name or ID (one used in the species count data). If you are not analyzing the default STOC data, you need one file of this kind.

Example dataset ::

"espece"  "nom"                       "nomscientific"               "indicateur"     "specialisation"
"ACCGEN"  "Autour des palombes"       "Accipiter gentilis"          FALSE            ""
"ACCNIS"  "Epervier d'Europe"         "Accipiter nisus"             FALSE            ""
"ACRARU"  "Rousserolle turdoïde"      "Acrocephalus arundinaceus"   FALSE            ""
"ACRMEL"  "Lusciniole à moustaches"   "Acrocephalus melanopogon"    FALSE            ""
"ACRPAL"  "Phragmite aquatique"       "Acrocephalus paludicola"     FALSE            ""
"ACRRIS"  "Rousserolle verderolle"    "Acrocephalus palustris"      FALSE            ""
"ACRSCH"  "Phragmite des joncs"       "Acrocephalus schoenobaenus"  FALSE            ""
"ACRSCI"  "Rousserolle effarvatte"    "Acrocephalus scirpaceus"     FALSE            ""
"ACTHYP"  "Chevalier guignette"       "Actitis hypoleucos"          FALSE            ""
"AEGCAU"  "Mésange à longue queue"    "Aegithalos caudatus"         FALSE            ""
"AEGFUN"  "Chouette de Tengmalm"      "Aegolius funereus"           FALSE            ""
"AIXGAL"  "Canard mandarin"           "Aix galericulata"            FALSE            ""
"AIXSPO"  "Canard carolin"            "Aix sponsa"                  FALSE            ""
"ALAARV"  "Alouette des champs"       "Alauda arvensis"             TRUE             "milieux agricoles"

|

**Source**

UnPublished script available at http://www.vigienature.fr/sites/vigienature/files/atoms/files/analysestoceps_0.zip
the first version written by Romain Lorrilliere.

Source script information:

Estimate temporal evolution of population by specialization group - ExeMainglmParGroupGalaxy.r
This script analyse the temporal evolution by group on and create graphical vizualisation.

Script needs the followings inputs :
 - stoc Yearly variation dataset. May come from the "Estimate temporal population evoution by species" tool (ExeMainGlmGalaxy.r).
 - stoc global variation dataset. May come from the "Estimate temporal population evoution by species" tool (ExeMainGlmGalaxy.r).
 - species details file with name and indicator status file with at least 2 columns: the species name or species ID (found in the community data or in stoc data) and his status as indicator species
 - file that stocks functions : "FunctTrendSTOCGalaxy.r"
 - A stoc bias tabular file


Arguments are :
 - spExclude: list of species (using the the species name or ID) that you want to exclude
 - analysis custom id


How to execute, eg :
 # all files are available in github repo
 #Exec id=mainglm_group, no species excluded
 $ Rscript ExeMainglmParGroupGalaxy.r yearly_variation.tabular global_variation.tabular tabSpecies.csv 'mainglm_group' '' FunctTrendSTOCGalaxy.r biais.tabular

Outputs are created in an Output repo :
GLM gives 3 tables :
- donneesGroupes_id.tabular
- variationsAnnuellesGroupes_id.tabular
- tendancesGlobalesGroupes_id.tabular


R library needed
r-lme4  version 1.1.18.1
r-ggplot2  version 3.0.0
r-speedglm  version 0.3.2
r-arm  version 1.10.1
r-reshape  version 0.8.8
r-data.table  version 1.12.0
r-reshape2   version 1.4.3


  ]]></help>
  <expand macro="stoceps_bibref" />
</tool>
